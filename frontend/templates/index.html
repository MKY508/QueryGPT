<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.3, user-scalable=yes">
    <title>QueryGPT - AI数据库查询</title>
    
    <!-- 外部资源 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <!-- 内部样式 -->
    <link rel="stylesheet" href="/static/css/design-system.css">
    <link rel="stylesheet" href="/static/css/core-layout.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/about-settings.css?v=20250821">
    <link rel="stylesheet" href="/static/css/dual-view-system.css">
    <link rel="stylesheet" href="/static/css/thinking-progress-enhanced.css">
    <link rel="stylesheet" href="/static/css/query-summary.css">
    <link rel="stylesheet" href="/static/css/history.css">
    <link rel="stylesheet" href="/static/css/model-modal.css">
    <link rel="stylesheet" href="/static/css/onboarding.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
    <link rel="stylesheet" href="/static/css/ui-fixes.css">
</head>
<body>
    <div class="container">
        <!-- 遮罩层 -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <!-- 移动端菜单按钮 -->
        <button class="mobile-menu-btn" id="menu-toggle-btn">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-chart-line"></i> QueryGPT</h2>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="menu-list">
                    <!-- 查询菜单 -->
                    <li class="menu-item has-submenu expanded">
                        <a href="#" class="menu-header">
                            <i class="fas fa-search"></i>
                            <span data-i18n="nav.query">查询</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="#" class="nav-link active" data-tab="chat">
                                    <i class="fas fa-plus-circle"></i> <span data-i18n="nav.newQuery">数据查询</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link" data-tab="history">
                                    <i class="fas fa-history"></i> <span data-i18n="nav.history">历史记录</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- 设置菜单 -->
                    <li class="menu-item has-submenu">
                        <a href="#" class="menu-header">
                            <i class="fas fa-cog"></i>
                            <span data-i18n="nav.settings">设置</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu" style="display: none;">
                            <li>
                                <a href="#" class="nav-link" data-tab="settings" data-settings-tab="basic">
                                    <i class="fas fa-cog"></i> <span data-i18n="nav.basicSettings">基础设置</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link" data-tab="settings" data-settings-tab="models">
                                    <i class="fas fa-brain"></i> <span data-i18n="nav.modelManagement">模型管理</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link" data-tab="settings" data-settings-tab="database">
                                    <i class="fas fa-database"></i> <span data-i18n="nav.databaseConfig">数据库配置</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link" data-tab="settings" data-settings-tab="prompts">
                                    <i class="fas fa-edit"></i> <span data-i18n="nav.promptSettings">Prompt设置</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    
                    <!-- 关于菜单 -->
                    <li class="menu-item">
                        <a href="#" class="menu-header" data-tab="about">
                            <i class="fas fa-info-circle"></i>
                            <span data-i18n="nav.about">关于</span>
                            <i class="submenu-arrow-placeholder"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
            </div>
        </aside>
        
        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 数据查询页面 -->
            <div class="tab-content active" id="chat-tab">
                <div class="chat-header">
                    <div class="header-left">
                        <h1 data-i18n="chat.title">数据查询与分析</h1>
                    </div>
                    <div class="header-controls">
                        <div class="model-selector">
                            <select id="current-model">
                                <option value="gpt-4.1">GPT-4.1</option>
                                <option value="claude-sonnet-4">Claude Sonnet 4</option>
                                <option value="deepseek-r1">DeepSeek R1</option>
                                <option value="qwen-flagship">Qwen 旗舰模型</option>
                            </select>
                        </div>
                        <button class="btn-new-conversation" id="new-conversation">
                            <i class="fas fa-plus"></i> <span data-i18n="chat.newConversation">新对话</span>
                        </button>
                        <button id="help-onboarding-btn" class="btn-onboarding" title="新手引导">
                            <i class="fas fa-question-circle"></i>
                            <span data-i18n="chat.onboarding">引导</span>
                        </button>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- 欢迎消息将由JavaScript动态生成 -->
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input">
                            <textarea id="message-input" 
                                      placeholder="输入查询内容..." 
                                      data-i18n="chat.inputPlaceholder"
                                      rows="3"></textarea>
                            <button id="send-button" class="send-button">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button id="stop-button" class="stop-button" style="display: none;" title="停止查询">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 导出结果页面 -->
            <div class="tab-content" id="export-tab">
                <div class="page-header">
                    <h1 data-i18n="export.title">导出结果</h1>
                </div>
                <div class="export-container">
                    <div class="settings-card">
                        <h3><i class="fas fa-file-export"></i> <span data-i18n="export.options">导出选项</span></h3>
                        <div class="form-group">
                            <label data-i18n="export.format">导出格式</label>
                            <select id="export-format">
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                                <option value="json">JSON (.json)</option>
                                <option value="html">HTML报表</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="export.content">包含内容</label>
                            <label class="checkbox-label">
                                <input type="checkbox" checked> 查询结果数据
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" checked> 可视化图表
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox"> 执行的SQL语句
                            </label>
                        </div>
                        <button class="btn-primary" id="export-data">
                            <i class="fas fa-download"></i> 导出数据
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 系统设置页面 -->
            <div class="tab-content" id="settings-tab">
                <div class="page-header">
                    <h1 data-i18n="settings.title">系统设置</h1>
                </div>
                
                <div class="settings-container">
                    <div class="settings-tabs">
                        <button type="button" class="settings-tab active" data-settings-tab="basic">
                            <i class="fas fa-cog"></i>
                            <span data-i18n="nav.basicSettings">基础设置</span>
                        </button>
                        <button type="button" class="settings-tab" data-settings-tab="models">
                            <i class="fas fa-brain"></i>
                            <span data-i18n="nav.modelManagement">模型管理</span>
                        </button>
                        <button type="button" class="settings-tab" data-settings-tab="database">
                            <i class="fas fa-database"></i>
                            <span data-i18n="nav.databaseConfig">数据库配置</span>
                        </button>
                        <button type="button" class="settings-tab" data-settings-tab="prompts">
                            <i class="fas fa-edit"></i>
                            <span data-i18n="nav.promptSettings">Prompt设置</span>
                        </button>
                    </div>
                    
                    <!-- 基础设置标签页 -->
                    <div class="settings-panel active" id="basic-settings">
                        <div class="settings-card">
                            <h3><i class="fas fa-cog"></i> <span data-i18n="settings.title">基础设置</span></h3>
                            <div class="form-group">
                                <label data-i18n="settings.language">语言</label>
                                <select id="language-select">
                                    <option value="en">English</option>
                                    <option value="zh">简体中文</option>
                                    <option value="zh-TW">繁體中文</option>
                                    <option value="ja">日本語</option>
                                    <option value="es">Español</option>
                                    <option value="fr">Français</option>
                                    <option value="de">Deutsch</option>
                                    <option value="ru">Русский</option>
                                    <option value="pt">Português</option>
                                    <option value="ko">한국어</option>
                                </select>
                                <small data-i18n="settings.languageDesc">选择系统界面语言</small>
                            </div>
                            <div class="form-group">
                                <label data-i18n="settings.viewMode">默认视图模式</label>
                                <select id="default-view-mode">
                                    <option value="user">用户模式（简洁）</option>
                                    <option value="developer">开发者模式（详细）</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-i18n="settings.contextRounds">上下文保留轮数</label>
                                <select id="context-rounds">
                                    <option value="0">不保留历史（单轮对话）</option>
                                    <option value="1">保留1轮历史</option>
                                    <option value="2">保留2轮历史</option>
                                    <option value="3" selected>保留3轮历史（推荐）</option>
                                    <option value="5">保留5轮历史</option>
                                    <option value="10">保留10轮历史（可能影响性能）</option>
                                </select>
                                <small data-i18n="settings.contextDesc">设置AI记住之前几轮对话的内容，用于错误修正和上下文理解</small>
                            </div>
                            
                            <div class="settings-toggle-grid">
                                <div class="form-group toggle-card">
                                    <div class="toggle-header">
                                <label>
                                    <span data-i18n="settings.smartRouting">智能路由</span>
                                    <span class="beta-badge">BETA</span>
                                </label>
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" id="smart-routing-toggle" checked>
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="switch-status" id="routing-status-text" data-i18n="settings.smartRoutingEnabled">已启用</span>
                                        </div>
                                </div>
                                <small data-i18n="settings.smartRoutingDesc">使用AI智能判断查询类型，自动选择最优执行路径，可显著提升简单查询的响应速度</small>
                                </div>
                                <div class="form-group toggle-card">
                                    <div class="toggle-header">
                                        <label data-i18n="settings.dbGuard">数据库守卫</label>
                                        <div class="switch-container">
                                            <label class="switch">
                                                <input type="checkbox" id="db-guard-toggle" checked>
                                                <span class="slider round"></span>
                                            </label>
                                            <span class="switch-status" id="db-guard-status" data-i18n="settings.toggleOn">已启用</span>
                                        </div>
                                    </div>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="db-guard-warn-toggle" checked>
                                        <span data-i18n="settings.dbGuardWarn">失败时提醒并允许继续执行</span>
                                    </label>
                                    <small data-i18n="settings.dbGuardDesc">运行前自动测试数据库连接，失败时提醒用户并可选择继续执行。</small>
                                </div>
                                <div class="form-group toggle-card">
                                    <div class="toggle-header">
                                        <label data-i18n="settings.thoughtStream">步骤播报</label>
                                        <div class="switch-container">
                                            <label class="switch">
                                                <input type="checkbox" id="thought-stream-toggle" checked>
                                                <span class="slider round"></span>
                                            </label>
                                            <span class="switch-status" id="thought-stream-status" data-i18n="settings.toggleOn">已启用</span>
                                        </div>
                                    </div>
                                    <small data-i18n="settings.thoughtStreamDesc">在执行每个主要动作前输出简短说明，实时展示智能助手的思考过程。</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="settings.thoughtTemplateZh">步骤模板（中文）</label>
                                <input type="text" id="thought-template-zh" placeholder="步骤{index}：{summary}">
                                <small data-i18n="settings.thoughtTemplateHint">使用 {index} 表示步骤编号，{summary} 表示操作说明。</small>
                            </div>
                            <div class="form-group">
                                <label data-i18n="settings.thoughtTemplateEn">Step Template (English)</label>
                                <input type="text" id="thought-template-en" placeholder="Step {index}: {summary}">
                                <small data-i18n="settings.thoughtTemplateHintEn">Use {index} for the step number and {summary} for the brief action description.</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 模型管理标签页 -->
                    <div class="settings-panel" id="models-settings">
                        <div class="settings-card">
                            <div class="card-header">
                                <h3><i class="fas fa-brain"></i> <span data-i18n="models.title">模型管理</span></h3>
                                <div class="card-actions">
                                    <button type="button" class="btn-primary" id="add-model-btn">
                                        <i class="fas fa-plus"></i> 新建模型
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 模型列表表格 -->
                            <div class="table-container">
                                <table class="models-table">
                                    <thead>
                                        <tr>
                                            <th data-i18n="models.name">模型名称</th>
                                            <th data-i18n="models.type">类型</th>
                                            <th data-i18n="models.apiAddress">API地址</th>
                                            <th data-i18n="models.status">状态</th>
                                            <th class="models-actions-header">
                                                <div class="actions-header-content">
                                                    <span data-i18n="models.actions">操作</span>
                                                    <button type="button" class="btn-secondary btn-sm" id="test-all-models-btn">
                                                        <i class="fas fa-sync-alt"></i> 一键测试
                                                    </button>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="models-list">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 数据库配置标签页 -->
                    <div class="settings-panel" id="database-settings">
                        <div class="settings-card">
                            <h3><i class="fas fa-database"></i> <span data-i18n="database.title">MySQL数据库配置</span></h3>
                            <div style="background-color: #f0f9ff; padding: 10px; margin-bottom: 20px; border-radius: 5px; border-left: 3px solid #3498db; font-size: 13px; color: #2c3e50;">
                                <i class="fas fa-info-circle" style="color: #3498db; margin-right: 5px;"></i>
                                <span data-i18n="database.compatibility">兼容所有 MySQL 协议数据库：OLAP（Doris、StarRocks、ClickHouse）、NewSQL（TiDB、OceanBase）</span>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="database.host">主机地址</label>
                                    <input type="text" id="db-host" placeholder="例如: localhost 或 192.168.1.100" data-i18n="database.hostPlaceholder">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="database.port">端口</label>
                                    <input type="number" id="db-port" placeholder="3306" value="3306">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-i18n="database.username">用户名</label>
                                    <input type="text" id="db-user" placeholder="数据库用户名" data-i18n="database.usernamePlaceholder">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="database.password">密码</label>
                                    <input type="password" id="db-password" placeholder="数据库密码" data-i18n="database.passwordPlaceholder">
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="database.dbName">数据库名</label>
                                <input type="text" id="db-name" placeholder="留空使用所有数据库" data-i18n="database.dbNamePlaceholder">
                                <small data-i18n="database.hint">提示：留空可访问所有可用数据库</small>
                            </div>
                            <div class="button-group">
                                <button class="btn-primary" id="test-db">
                                    <i class="fas fa-plug"></i> <span data-i18n="database.testConnection">测试连接</span>
                                </button>
                                <button class="btn-secondary" id="save-db-config">
                                    <i class="fas fa-save"></i> <span data-i18n="database.saveConfig">保存配置</span>
                                </button>
                            </div>
                            
                            <!-- 连接状态显示 -->
                            <div class="connection-status-box" id="db-connection-status" style="display: none;">
                                <div class="status-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="status-info">
                                    <h4 data-i18n="database.connectionSuccess">连接成功</h4>
                                    <p><span data-i18n="database.connectionInfo">数据库连接正常，共发现</span> <span id="table-count">0</span> <span>个表</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prompt设置标签页 -->
                    <div class="settings-panel" id="prompts-settings">
                        <div class="settings-card">
                            <h3><i class="fas fa-edit"></i> <span data-i18n="prompts.title">Prompt设置</span></h3>
                            <p class="settings-description">
                                <span data-i18n="prompts.description">自定义查询模块使用的提示词，可以根据您的业务需求调整AI的行为模式。</span>
                            </p>
                            
                            <!-- 智能路由提示词部分 -->
                            <div class="prompt-section" id="routing-prompts-section">
                                <h4 class="collapsible-header collapsed">
                                    <i class="fas fa-route"></i> 
                                    <span data-i18n="prompts.routingPrompt">智能路由提示词</span>
                                    <i class="fas fa-chevron-down collapse-icon"></i>
                                </h4>
                                
                                <div class="collapsible-content collapsed">
                                    <!-- 路由分类提示词 -->
                                    <div class="form-group">
                                        <label data-i18n="prompts.routingClassifier">路由分类策略</label>
                                        <textarea id="prompt-routing" rows="10" placeholder="设置智能路由分类策略..." class="routing-prompt">你是一个查询路由分类器。分析用户查询，选择最适合的执行路径，并仅输出规范 JSON。

用户查询：{query}

数据库信息：
- 类型：{db_type}
- 可用表：{available_tables}

请从以下路由中选择其一：

1. QA
   - 适用：闲聊、与数据库无关的问题
   - 输出：礼貌拒绝或引导用户提供数据库需求
   - 不执行 SQL 或代码

2. ANALYSIS
   - 适用：与数据库相关的取数或数据分析任务（无论简单查询还是多步分析）
   - 允许：执行 Python、生成图表，必要时经用户确认安装库

如判断输入与数据库无关，应选择 QA。
如用户请求涉及数据库或需要分析（包含简单取数），请选择 ANALYSIS 并在 reason 中说明判断依据。

输出 JSON（仅此内容）：
{
  "route": "QA | ANALYSIS",
  "confidence": 0.0-1.0,
  "reason": "简要说明判断依据",
  "suggested_plan": ["步骤1", "步骤2"]
}

若无法判定，请将 route 设置为 "ANALYSIS" 并说明原因。</textarea>
                                    </div>
                                    
                                    <!-- 各路由类型的独立prompt -->
                                    <div class="route-type-prompts">
                                        <div class="form-group">
                                            <label>QA Prompt（礼貌拒绝）</label>
                                            <textarea id="prompt-qa" rows="4" placeholder="设置QA路线的提示词..." class="routing-prompt">你是一个数据库助手。当用户提问与数据库或分析无关时，请礼貌拒绝并引导用户提供需要查询的表、指标或时间范围。</textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>ANALYSIS Prompt（深度分析）</label>
                                            <textarea id="prompt-analysis" rows="12" placeholder="设置ANALYSIS路线的提示词..." class="routing-prompt">你是 QueryGPT 的数据分析助手，负责从只读数据库中探索、取数并生成业务洞察。请遵循以下流程：

【阶段 1：建立连接】
- 使用提供的 pymysql 参数建立连接（失败时说明 host:port 与报错并结束）。
- 连接成功后执行 SELECT VERSION() 获取数据库方言。

【阶段 2：数据库探索策略（未指定 database 时）】
1. cursor.execute("SHOW DATABASES")
2. 根据业务关键词与优先级筛选库：销售相关优先匹配 sales/trade/order/trd；仓库优先级 center_dws > dws > dwh > dw > ods > ads
3. cursor.execute(f"USE `{target_db}`")
4. cursor.execute("SHOW TABLES")
5. 对候选表执行 DESCRIBE 与 SELECT * LIMIT 10 验证结构与样本

【阶段 3：表选择与字段策略】
- 优先选择包含 trd/trade/order/sale + detail/day 的表；避免 production/forecast/plan/budget
- 字段识别：月份 v_month > month > year_month > year_of_month；销量 sale_num > sale_qty > quantity > qty；金额 pay_amount > order_amount > total_amount

【阶段 4：数据处理与分析】
- Decimal 转 float，统一日期格式，必要时在 SQL 中过滤异常值
- 编写只读 SQL，使用 pandas 处理；需要可视化时用 plotly 保存到 output/ 目录
- 操作前可用 print(f"[步骤 {{index}}] {{summary}}") 说明动作，真实发现请用普通文本描述
- 严禁访问本地 CSV/Excel/SQLite 文件，除非用户明确授权

【阶段 5：输出要求】
- 说明完成的操作、关键发现、局限与下一步建议
- 若遇阻断（连接失败、无匹配数据等），说明具体原因并提供排查建议
- 仅在多次探索仍缺少信息时，礼貌向用户询问补充细节。</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="prompt-section" id="database-prompts-section">
                                <h4 class="collapsible-header collapsed">
                                    <i class="fas fa-database"></i>
                                    <span data-i18n="prompts.databaseQuery">数据库查询提示词</span>
                                    <i class="fas fa-chevron-down collapse-icon"></i>
                                </h4>
                                <div class="collapsible-content collapsed">
                                    <div class="form-group">
                                        <label data-i18n="prompts.explorationStrategy">探索策略</label>
                                        <textarea id="prompt-exploration" rows="6" placeholder="设置数据库探索策略...">先理解用户需求中的业务语义：
* "销量"通常指实际销售数量（sale_num/sale_qty/quantity）
* "订单金额"指实际成交金额（knead_pay_amount/pay_amount）

数据库选择优先级：
* 优先探索数据仓库：center_dws > dws > dwh > dw
* 其次考虑：ods（原始数据）> ads（汇总数据）</textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label data-i18n="prompts.tableSelection">表选择策略</label>
                                        <textarea id="prompt-table-selection" rows="4" placeholder="设置表选择策略...">优先选择包含：trd/trade/order/sale + detail/day 的表（交易明细表）
避免：production/forecast/plan/budget（计划类表）
检查表数据量和日期范围，确保包含所需时间段</textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label data-i18n="prompts.fieldMapping">字段识别规则</label>
                                        <textarea id="prompt-field-mapping" rows="4" placeholder="设置字段识别规则...">月份字段：v_month > month > year_month > year_of_month
销量字段：sale_num > sale_qty > quantity > qty
金额字段：pay_amount > order_amount > total_amount</textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label data-i18n="prompts.dataProcessing">数据处理规则</label>
                                        <textarea id="prompt-data-processing" rows="4" placeholder="设置数据处理规则...">Decimal类型需转换为float进行计算
日期格式统一处理（如 '2025-01' 格式）
如果发现负销量或异常值，在SQL中用WHERE条件过滤</textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label data-i18n="prompts.outputRequirements">输出要求</label>
                                        <textarea id="prompt-output-requirements" rows="4" placeholder="设置输出要求...">使用 plotly 生成可视化图表
将 HTML 文件保存到 output 目录
提供简洁的总结，包括完成的任务和关键发现</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 高级Prompt（可选） -->
                            <div class="prompt-section">
                                <h4 class="collapsible-header collapsed">
                                    <i class="fas fa-tools"></i> 
                                    <span>高级 Prompt（可选）</span>
                                    <i class="fas fa-chevron-down collapse-icon"></i>
                                </h4>
                                <div class="collapsible-content collapsed">
                                    <div class="form-group">
                                        <label>总结输出（用户视角）</label>
                                        <textarea id="prompt-summarization" rows="3" placeholder="设置结果总结的风格与要求..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>错误处理（友好说明）</label>
                                        <textarea id="prompt-error-handling" rows="3" placeholder="设置错误处理的风格与建议..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>可视化指引</label>
                                        <textarea id="prompt-visualization" rows="3" placeholder="设置可视化生成的标准..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>数据分析指引</label>
                                        <textarea id="prompt-data-analysis" rows="3" placeholder="设置数据分析的标准..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>SQL 生成指引</label>
                                        <textarea id="prompt-sql-generation" rows="3" placeholder="设置只读SQL生成的标准..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>代码审查指引</label>
                                        <textarea id="prompt-code-review" rows="3" placeholder="设置代码审查的标准..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>进度归纳（短标签）</label>
                                        <textarea id="prompt-progress-planner" rows="3" placeholder="设置将执行阶段归纳为不超过10字短语的规则..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn-primary" id="save-prompts">
                                    <i class="fas fa-save"></i> <span data-i18n="prompts.save">保存设置</span>
                                </button>
                                <button class="btn-secondary" id="reset-prompts">
                                    <i class="fas fa-undo"></i> <span data-i18n="prompts.reset">恢复默认</span>
                                </button>
                                <button class="btn-secondary" id="export-prompts">
                                    <i class="fas fa-download"></i> <span data-i18n="prompts.export">导出配置</span>
                                </button>
                                <button class="btn-secondary" id="import-prompts">
                                    <i class="fas fa-upload"></i> <span data-i18n="prompts.import">导入配置</span>
                                </button>
                            </div>
                            
                            <div class="prompt-tips">
                                <h4><i class="fas fa-info-circle"></i> <span data-i18n="prompts.tipsTitle">使用提示</span></h4>
                                <ul>
                                    <li data-i18n="prompts.tip1">修改提示词可以让AI更好地理解您的业务场景</li>
                                    <li data-i18n="prompts.tip2">建议先备份当前配置再进行修改</li>
                                    <li data-i18n="prompts.tip3">恢复默认会将所有提示词重置为系统默认值</li>
                                    <li data-i18n="prompts.tip4">支持导入导出配置，方便在不同环境间迁移</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            
            <!-- 关于页面 -->
            <div class="tab-content" id="about-tab">
                <div class="about-header">
                    <h1 data-i18n="about.title">关于系统</h1>
                </div>
                
                <div class="about-hero">
                    <div class="hero-content">
                        <div class="logo-section">
                            <img src="/static/images/logo.png" alt="QueryGPT Logo" style="width: 320px; height: auto; margin: 0 auto; display: block;">
                        </div>
                        <div class="hero-info">
                            <p class="system-version" style="color: #6c757d;"><span data-i18n="about.version">版本</span> v1.5 | <span data-i18n="about.releaseDate">2025年11月</span></p>
                            <div class="hero-badges">
                                <span class="badge-item">
                                    <i class="fas fa-robot"></i> <span data-i18n="about.features.ai">智能数据分析</span>
                                </span>
                                <span class="badge-item">
                                    <i class="fas fa-database"></i> <span data-i18n="about.features.database">数据库查询</span>
                                </span>
                                <span class="badge-item">
                                    <i class="fas fa-chart-pie"></i> <span data-i18n="about.features.visualization">可视化生成</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="about-cards">
                    <div class="about-card">
                        <div class="card-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-i18n="about.developer">开发者</h3>
                            <p class="card-main">MKY</p>
                            <p class="card-sub" data-i18n="about.independentDev">独立开发者</p>
                        </div>
                    </div>
                    
                    <div class="about-card">
                        <div class="card-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-i18n="about.organization">所属单位</h3>
                            <p class="card-main" data-i18n="about.openSource">开源项目</p>
                            <p class="card-sub">MIT License</p>
                        </div>
                    </div>
                    
                    <div class="about-card">
                        <div class="card-icon">
                            <i class="fas fa-code-branch"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-i18n="about.versionInfo">版本信息</h3>
                            <p class="card-main">v1.5</p>
                            <p class="card-sub" data-i18n="about.stableVersion">正式版本</p>
                        </div>
                    </div>
                    
                    <div class="about-card">
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-i18n="about.updateTime">更新时间</h3>
                            <p class="card-main" data-i18n="about.releaseDate">2025年8月</p>
                            <p class="card-sub" data-i18n="about.maintaining">持续维护中</p>
                        </div>
                    </div>
                </div>
                
                <div class="license-section">
                    <h2><i class="fas fa-file-contract"></i> <span data-i18n="about.license">许可证说明</span></h2>
                    <div class="license-content">
                        <div class="license-item">
                            <strong data-i18n="about.licenseDetails.openInterpreter">OpenInterpreter 核心引擎：</strong> <span data-i18n="about.licenseDetails.openInterpreterLicense">MIT许可证</span>
                            <span class="license-info">
                                <i class="fas fa-info-circle"></i> 
                                <span data-i18n="about.licenseDetails.openInterpreterDesc">开源自然语言代码执行引擎，允许商业使用</span>
                            </span>
                            <div class="license-details">
                                <small data-i18n="about.licenseDetails.openInterpreterDetail1">• 本项目使用pip安装的0.4.3版本，遵循MIT许可证</small>
                                <small data-i18n="about.licenseDetails.openInterpreterDetail2">• 允许自由使用、修改和部署</small>
                                <small data-i18n="about.licenseDetails.openInterpreterDetail3">• 提供自然语言转代码的核心AI能力</small>
                            </div>
                        </div>
                        <div class="license-item">
                            <strong data-i18n="about.licenseDetails.otherLibs">Flask/PyMySQL/Plotly等：</strong> <span data-i18n="about.licenseDetails.otherLibsLicense">MIT/BSD许可证</span>
                            <span class="license-info">
                                <i class="fas fa-info-circle"></i> 
                                <span data-i18n="about.licenseDetails.otherLibsDesc">允许商业使用、修改和分发</span>
                            </span>
                            <div class="license-details">
                                <small data-i18n="about.licenseDetails.flaskDetail">• Flask 3.1.1 - 轻量级Web框架，BSD许可证</small>
                                <small data-i18n="about.licenseDetails.pymysqlDetail">• PyMySQL 1.1.1 - MySQL数据库连接库，MIT许可证</small>
                                <small data-i18n="about.licenseDetails.plotlyDetail">• Plotly 6.3.0 - 数据可视化库，MIT许可证</small>
                                <small data-i18n="about.licenseDetails.allOpenSource">• 所有依赖均为开源许可证</small>
                            </div>
                        </div>
                        <div class="license-item">
                            <div class="license-notice">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong data-i18n="about.licenseDetails.disclaimer">免责声明：</strong> <span data-i18n="about.licenseDetails.disclaimerText">本系统为大模型驱动的工具，开发者对使用过程中可能出现的数据损失或其他问题不承担责任。请在使用前做好数据备份和权限管理。</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 技术栈部分 -->
                <div class="tech-stack-section">
                    <h2><i class="fas fa-layer-group"></i> <span data-i18n="about.techStack">技术栈</span></h2>
                    <div class="tech-grid">
                        <div class="tech-group">
                            <h3><i class="fas fa-server"></i> <span data-i18n="about.backend">后端技术</span></h3>
                            <div class="tech-badges">
                                <span class="tech-badge">Python 3.10</span>
                                <span class="tech-badge">Flask 3.1.1</span>
                                <span class="tech-badge">OpenInterpreter 0.4.3</span>
                                <span class="tech-badge">PyMySQL 1.1.1</span>
                                <span class="tech-badge">Pandas 2.3.1</span>
                                <span class="tech-badge">Plotly 6.3.0</span>
                            </div>
                        </div>
                        <div class="tech-group">
                            <h3><i class="fas fa-palette"></i> <span data-i18n="about.frontend">前端技术</span></h3>
                            <div class="tech-badges">
                                <span class="tech-badge">HTML5</span>
                                <span class="tech-badge">CSS3</span>
                                <span class="tech-badge">JavaScript ES6</span>
                                <span class="tech-badge">Plotly.js</span>
                                <span class="tech-badge">Marked.js</span>
                                <span class="tech-badge">Highlight.js</span>
                            </div>
                        </div>
                        <div class="tech-group">
                            <h3><i class="fas fa-database"></i> <span data-i18n="nav.databaseConfig">数据库</span></h3>
                            <div class="tech-badges">
                                <span class="tech-badge">MySQL Protocol</span>
                                <span class="tech-badge">Compatible Databases</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="system-usage">
                    <h2><i class="fas fa-info-circle"></i> <span data-i18n="about.usageStatement">本系统使用声明</span></h2>
                    <p data-i18n="about.systemDesc">本系统基于开源组件开发，采用 MIT 许可证：</p>
                    <ul>
                        <li data-i18n="about.freeUse">自由使用、修改和分发</li>
                        <li data-i18n="about.commercial">支持商业和非商业用途</li>
                        <li data-i18n="about.copyright">请保留版权声明</li>
                    </ul>
                    <div class="developer-contact">
                        <p><i class="fas fa-envelope"></i> <strong data-i18n="about.contactEmail">开发者联系邮箱：</strong> mky369258@gmail.com</p>
                    </div>
                </div>
            </div>
            
            <!-- 历史记录页面 -->
            <div class="tab-content" id="history-tab">
                <div class="history-container">
                    <div class="history-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 class="history-title" style="margin: 0;">
                                <i class="fas fa-history"></i>
                                <span data-i18n="history.title">历史记录</span>
                            </h2>
                            <button id="refresh-history-btn" class="btn-icon" title="刷新历史记录" 
                                    style="background: white; border: 1px solid #dee2e6; color: #6c757d; 
                                           padding: 8px 12px; border-radius: 6px; cursor: pointer; 
                                           transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#f8f9fa'; this.style.transform='rotate(180deg)'"
                                    onmouseout="this.style.background='white'; this.style.transform='rotate(0deg)'"
                                    onclick="if(window.HistoryManager.instance) { window.HistoryManager.instance.loadRecentConversations(); this.style.transform='rotate(360deg)'; }">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div class="history-search-container">
                            <input type="text" id="history-search" placeholder="搜索历史记录..." data-i18n="history.search">
                            <i class="fas fa-search history-search-icon"></i>
                        </div>
                        
                        <div class="history-filters">
                            <button class="history-filter-btn active" data-filter="recent">
                                <i class="fas fa-clock"></i> <span data-i18n="history.recent">最近</span>
                            </button>
                            <button class="history-filter-btn" data-filter="today">
                                <i class="fas fa-calendar-day"></i> <span data-i18n="history.today">今天</span>
                            </button>
                            <button class="history-filter-btn" data-filter="week">
                                <i class="fas fa-calendar-week"></i> <span data-i18n="history.thisWeek">本周</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="history-list-container" id="history-list-container">
                        <div id="history-loading" class="history-loading">
                            <div class="history-loading-spinner"></div>
                            <p data-i18n="history.loading">加载中...</p>
                        </div>
                        <div id="history-list"></div>
                    </div>
                    
                </div>
            </div>
            
        </main>
    </div>
    
    <!-- 全局通知 -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="notification-icon"></i>
            <span class="notification-text"></span>
        </div>
    </div>
    
    <!-- 加载提示 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p data-i18n="common.loading">处理中...</p>
        </div>
    </div>
    
    <!-- 模型配置弹窗 -->
    <div class="modal" id="model-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="model-modal-title">编辑模型</h2>
                <button class="modal-close" onclick="window.settingsManager.closeModelModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>模型名称</label>
                    <input type="text" id="model-name" placeholder="例如: GPT-4" data-i18n="models.modelNamePlaceholder">
                </div>
                <div class="form-group">
                    <label>模型ID</label>
                    <input type="text" id="model-id" placeholder="例如: gpt-4" data-i18n="models.modelIdPlaceholder">
                </div>
                <div class="form-group">
                    <label>类型</label>
                    <select id="model-type">
                        <option value="openai">OpenAI (ChatGPT)</option>
                        <option value="qwen">Qwen (阿里百炼)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="anthropic">Anthropic Claude</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="mistral">Mistral AI</option>
                        <option value="groq">Groq</option>
                        <option value="azure">Azure OpenAI</option>
                        <option value="moonshot">Moonshot (Kimi)</option>
                        <option value="fireworks">Fireworks AI</option>
                        <option value="cohere">Cohere</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="perplexity">Perplexity</option>
                        <option value="bedrock">AWS Bedrock</option>
                        <option value="ollama">Ollama (本地)</option>
                        <option value="custom">自定义 / 兼容</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>API地址</label>
                    <input type="text" id="model-api-base" placeholder="例如: https://api.openai.com/v1" data-i18n="models.apiBasePlaceholder">
                    <small id="model-api-base-hint" style="display:block;color:#6c757d;font-size:12px;margin-top:4px;"></small>
                </div>
                <div class="form-group">
                    <label>API密钥</label>
                    <input type="password" id="model-api-key" placeholder="输入API密钥" data-i18n="models.apiKeyPlaceholder">
                    <small id="model-api-key-hint" style="display:block;color:#6c757d;font-size:12px;margin-top:4px;"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="window.settingsManager.closeModelModal()">取消</button>
                <button class="btn-primary" id="save-model-btn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 删除确认弹窗 -->
    <div class="delete-modal" id="delete-modal">
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <i class="fas fa-exclamation-triangle delete-modal-icon"></i>
                <h3 class="delete-modal-title">确认删除</h3>
            </div>
            <div class="delete-modal-body">
                <span data-i18n="history.deleteConfirm">确定要删除这个对话吗？此操作无法撤销。</span>
            </div>
            <div class="delete-modal-footer">
                <button class="delete-modal-btn delete-modal-btn-cancel" onclick="window.HistoryManager.instance.closeDeleteModal()">
                    <span data-i18n="history.cancel">取消</span>
                </button>
                <button class="delete-modal-btn delete-modal-btn-delete" id="confirm-delete-btn">
                    <i class="fas fa-trash"></i> <span data-i18n="history.delete">删除</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <!-- i18n.js 需要提前加载，因为其他脚本依赖它 -->
    <script src="/static/js/i18n.js"></script>
    <!-- 其他脚本使用 defer 延迟加载，不阻塞页面渲染 -->
    <script src="/static/js/performance.js" defer></script>
    <script src="/static/js/error-handler.js" defer></script>
    <script src="/static/js/state.js" defer></script>
    <script src="/static/js/api.js" defer></script>
    <script src="/static/js/ui.js" defer></script>
    <script src="/static/js/settings.js" defer></script>
    <script src="/static/js/view-helpers.js" defer></script>
    <script type="module" src="/static/js/app.js" defer></script>
    <script src="/static/js/context-rounds-fix.js" defer></script>
    <script src="/static/js/onboarding.js" defer></script>
</body>
</html>
