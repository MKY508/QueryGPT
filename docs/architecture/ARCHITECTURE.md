# QueryGPT v2 æ¶æ„è®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

QueryGPT æ˜¯ä¸€ä¸ªè‡ªç„¶è¯­è¨€æ•°æ®åº“æŸ¥è¯¢åŠ©æ‰‹ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€ä¸æ•°æ®åº“äº¤äº’ï¼Œè·å–æ•°æ®åˆ†æå’Œå¯è§†åŒ–ç»“æœã€‚

### 1.1 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° |
|------|------|
| è‡ªç„¶è¯­è¨€æŸ¥è¯¢ | ç”¨æˆ·è¾“å…¥è‡ªç„¶è¯­è¨€ï¼Œç³»ç»Ÿç”Ÿæˆå¹¶æ‰§è¡Œ SQL |
| æµå¼å“åº” | å®æ—¶æ˜¾ç¤º AI æ€è€ƒè¿‡ç¨‹å’Œæ‰§è¡Œæ­¥éª¤ |
| æ•°æ®å¯è§†åŒ– | è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ï¼ˆæŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ç­‰ï¼‰ |
| å¤šæ¨¡å‹æ”¯æŒ | æ”¯æŒ OpenAIã€Anthropicã€æœ¬åœ°æ¨¡å‹ç­‰ |
| å¤šæ•°æ®åº“æ”¯æŒ | MySQLã€PostgreSQLã€SQLite |
| å†å²è®°å½• | ä¿å­˜å’Œç®¡ç†å¯¹è¯å†å² |
| å¤šç”¨æˆ· | ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™ç®¡ç† |
| åŒè§†å›¾æ¨¡å¼ | ç”¨æˆ·è§†å›¾ï¼ˆç®€æ´ï¼‰å’Œå¼€å‘è€…è§†å›¾ï¼ˆè¯¦ç»†ï¼‰ |

### 1.2 æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (Next.js 15)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Framework    â”‚ Next.js 15 (App Router)                     â”‚
â”‚  UI Library   â”‚ shadcn/ui + Tailwind CSS 4                  â”‚
â”‚  State        â”‚ Zustand + TanStack Query v5                 â”‚
â”‚  Charts       â”‚ Recharts / ECharts                          â”‚
â”‚  i18n         â”‚ next-intl                                   â”‚
â”‚  Language     â”‚ TypeScript 5.x                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ REST API + SSE
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯ (FastAPI)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Framework    â”‚ FastAPI 0.115+                              â”‚
â”‚  ORM          â”‚ SQLAlchemy 2.0 (async)                      â”‚
â”‚  Validation   â”‚ Pydantic v2                                 â”‚
â”‚  AI Engine    â”‚ gptme + LiteLLM                             â”‚
â”‚  Auth         â”‚ JWT + OAuth2                                â”‚
â”‚  Database     â”‚ PostgreSQL (ä¸») / MySQL / SQLite            â”‚
â”‚  Cache        â”‚ Redis (å¯é€‰)                                â”‚
â”‚  Language     â”‚ Python 3.11+                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®¢æˆ·ç«¯å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Web App   â”‚  â”‚  Mobile App â”‚  â”‚   CLI Tool  â”‚              â”‚
â”‚  â”‚  (Next.js)  â”‚  â”‚   (Future)  â”‚  â”‚   (Future)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPS
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API ç½‘å…³å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    FastAPI Application                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚   Auth   â”‚ â”‚   Chat   â”‚ â”‚  History â”‚ â”‚  Config  â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  Router  â”‚ â”‚  Router  â”‚ â”‚  Router  â”‚ â”‚  Router  â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚            â”‚            â”‚            â”‚
           â–¼            â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æœåŠ¡å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Auth   â”‚ â”‚Execution â”‚ â”‚  History â”‚ â”‚  Config  â”‚            â”‚
â”‚  â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚            â”‚            â”‚            â”‚                   â”‚
â”‚       â”‚      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”      â”‚            â”‚                   â”‚
â”‚       â”‚      â”‚   gptme   â”‚      â”‚            â”‚                   â”‚
â”‚       â”‚      â”‚  Engine   â”‚      â”‚            â”‚                   â”‚
â”‚       â”‚      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚            â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ•°æ®å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  PostgreSQL  â”‚  â”‚ Target DBs   â”‚  â”‚    Redis     â”‚           â”‚
â”‚  â”‚  (App Data)  â”‚  â”‚ (User Query) â”‚  â”‚   (Cache)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ "æŸ¥è¯¢ä¸Šæœˆé”€å”®é¢"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å‰ç«¯å‘é€    â”‚ POST /api/v1/chat/stream
â”‚     SSE è¯·æ±‚    â”‚ { query: "æŸ¥è¯¢ä¸Šæœˆé”€å”®é¢", model: "gpt-4o" }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è®¤è¯ä¸­é—´ä»¶  â”‚ éªŒè¯ JWT Token
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Chat Router â”‚ è§£æè¯·æ±‚ï¼Œåˆ›å»ºä¼šè¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Execution   â”‚ è°ƒç”¨ gptme æ‰§è¡Œ
â”‚     Service     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º SSE: { type: "progress", data: { stage: "analyzing" } }
         â”‚
         â”œâ”€â”€â–º SSE: { type: "progress", data: { stage: "generating_sql" } }
         â”‚
         â”œâ”€â”€â–º SSE: { type: "progress", data: { stage: "executing" } }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ‰§è¡Œ SQL    â”‚ è¿æ¥ç›®æ ‡æ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º SSE: { type: "result", data: { sql: "...", data: [...] } }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. ç”Ÿæˆå¯è§†åŒ–  â”‚ æ ¹æ®æ•°æ®ç”Ÿæˆå›¾è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º SSE: { type: "visualization", data: { chart: {...} } }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. ä¿å­˜å†å²    â”‚ å­˜å‚¨åˆ° PostgreSQL
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â–º SSE: { type: "done", data: { conversation_id: "..." } }
```

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users      â”‚       â”‚   connections   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â”€â”€â”    â”‚ id (PK)         â”‚
â”‚ email           â”‚  â”‚    â”‚ user_id (FK)    â”‚â”€â”€â”
â”‚ hashed_password â”‚  â”‚    â”‚ name            â”‚  â”‚
â”‚ display_name    â”‚  â”‚    â”‚ driver          â”‚  â”‚
â”‚ avatar_url      â”‚  â”‚    â”‚ host            â”‚  â”‚
â”‚ role            â”‚  â”‚    â”‚ port            â”‚  â”‚
â”‚ is_active       â”‚  â”‚    â”‚ username        â”‚  â”‚
â”‚ created_at      â”‚  â”‚    â”‚ password_enc    â”‚  â”‚
â”‚ updated_at      â”‚  â”‚    â”‚ database        â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚ is_default      â”‚  â”‚
                     â”‚    â”‚ created_at      â”‚  â”‚
                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                     â”‚                         â”‚
                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                     â”‚    â”‚  conversations  â”‚  â”‚
                     â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
                     â””â”€â”€â”€â–ºâ”‚ id (PK)         â”‚  â”‚
                          â”‚ user_id (FK)    â”‚â—„â”€â”˜
                          â”‚ connection_id   â”‚
                          â”‚ title           â”‚
                          â”‚ model           â”‚
                          â”‚ is_favorite     â”‚
                          â”‚ status          â”‚
                          â”‚ created_at      â”‚
                          â”‚ updated_at      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ 1:N
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    messages     â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚ id (PK)         â”‚
                          â”‚ conversation_id â”‚
                          â”‚ role            â”‚
                          â”‚ content         â”‚
                          â”‚ metadata        â”‚
                          â”‚ created_at      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     models      â”‚       â”‚     prompts     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ user_id (FK)    â”‚       â”‚ user_id (FK)    â”‚
â”‚ name            â”‚       â”‚ name            â”‚
â”‚ provider        â”‚       â”‚ type            â”‚
â”‚ model_id        â”‚       â”‚ content_zh      â”‚
â”‚ base_url        â”‚       â”‚ content_en      â”‚
â”‚ api_key_enc     â”‚       â”‚ is_default      â”‚
â”‚ is_default      â”‚       â”‚ created_at      â”‚
â”‚ created_at      â”‚       â”‚ updated_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¡¨ç»“æ„è¯¦æƒ…

è§ `docs/api/DATABASE.md`

## 4. API è®¾è®¡

### 4.1 API ç‰ˆæœ¬ç­–ç•¥

- æ‰€æœ‰ API ä»¥ `/api/v1/` ä¸ºå‰ç¼€
- é‡å¤§å˜æ›´æ—¶å¢åŠ ç‰ˆæœ¬å· `/api/v2/`
- æ—§ç‰ˆæœ¬ä¿æŒå…¼å®¹è‡³å°‘ 6 ä¸ªæœˆ

### 4.2 API ç«¯ç‚¹æ¦‚è§ˆ

| æ¨¡å— | ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|------|
| **è®¤è¯** | `/api/v1/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| | `/api/v1/auth/login` | POST | ç”¨æˆ·ç™»å½• |
| | `/api/v1/auth/refresh` | POST | åˆ·æ–° Token |
| | `/api/v1/auth/me` | GET | è·å–å½“å‰ç”¨æˆ· |
| **èŠå¤©** | `/api/v1/chat/stream` | GET | SSE æµå¼èŠå¤© |
| | `/api/v1/chat/stop` | POST | åœæ­¢æ‰§è¡Œ |
| **å†å²** | `/api/v1/conversations` | GET | è·å–å¯¹è¯åˆ—è¡¨ |
| | `/api/v1/conversations/{id}` | GET | è·å–å¯¹è¯è¯¦æƒ… |
| | `/api/v1/conversations/{id}` | DELETE | åˆ é™¤å¯¹è¯ |
| **æ¨¡å‹** | `/api/v1/models` | GET | è·å–æ¨¡å‹åˆ—è¡¨ |
| | `/api/v1/models` | POST | æ·»åŠ æ¨¡å‹ |
| | `/api/v1/models/{id}` | PUT | æ›´æ–°æ¨¡å‹ |
| | `/api/v1/models/{id}` | DELETE | åˆ é™¤æ¨¡å‹ |
| **è¿æ¥** | `/api/v1/connections` | GET | è·å–æ•°æ®åº“è¿æ¥ |
| | `/api/v1/connections` | POST | æ·»åŠ è¿æ¥ |
| | `/api/v1/connections/{id}/test` | POST | æµ‹è¯•è¿æ¥ |
| **é…ç½®** | `/api/v1/config` | GET | è·å–é…ç½® |
| | `/api/v1/config` | PUT | æ›´æ–°é…ç½® |

è¯¦ç»† API æ–‡æ¡£è§ `docs/api/API.md`

## 5. å®‰å…¨è®¾è®¡

### 5.1 è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client â”‚                    â”‚   API   â”‚                    â”‚   DB    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                              â”‚                              â”‚
     â”‚  POST /auth/login            â”‚                              â”‚
     â”‚  { email, password }         â”‚                              â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
     â”‚                              â”‚  æŸ¥è¯¢ç”¨æˆ·                     â”‚
     â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚                              â”‚
     â”‚                              â”‚  éªŒè¯å¯†ç  (bcrypt)            â”‚
     â”‚                              â”‚                              â”‚
     â”‚  { access_token,             â”‚                              â”‚
     â”‚    refresh_token }           â”‚                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
     â”‚                              â”‚                              â”‚
     â”‚  GET /chat/stream            â”‚                              â”‚
     â”‚  Authorization: Bearer xxx   â”‚                              â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
     â”‚                              â”‚  éªŒè¯ JWT                    â”‚
     â”‚                              â”‚                              â”‚
     â”‚  SSE Response                â”‚                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
```

### 5.2 å®‰å…¨æªæ–½

| æªæ–½ | å®ç° |
|------|------|
| å¯†ç å­˜å‚¨ | bcrypt å“ˆå¸Œ |
| Token | JWT (RS256) |
| API å¯†é’¥å­˜å‚¨ | AES-256 åŠ å¯† |
| SQL æ³¨å…¥é˜²æŠ¤ | å‚æ•°åŒ–æŸ¥è¯¢ + åªè¯»é™åˆ¶ |
| XSS é˜²æŠ¤ | è¾“å‡ºè½¬ä¹‰ + CSP |
| CORS | ç™½åå•åŸŸå |
| é€Ÿç‡é™åˆ¶ | æ»‘åŠ¨çª—å£ç®—æ³• |

## 6. éƒ¨ç½²æ¶æ„

### 6.1 Docker Compose (å¼€å‘/å°è§„æ¨¡)

```yaml
services:
  web:
    build: ./apps/web
    ports: ["3000:3000"]

  api:
    build: ./apps/api
    ports: ["8000:8000"]
    depends_on: [db, redis]

  db:
    image: postgres:16
    volumes: [pgdata:/var/lib/postgresql/data]

  redis:
    image: redis:7-alpine
```

### 6.2 Kubernetes (ç”Ÿäº§)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Ingress                               â”‚
â”‚                    (nginx-ingress)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚               â”‚
          â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Web Pod  â”‚   â”‚ API Pod  â”‚   â”‚ API Pod  â”‚
    â”‚ (Next.js)â”‚   â”‚(FastAPI) â”‚   â”‚(FastAPI) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                        â”‚              â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                    â–¼                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚PostgreSQLâ”‚         â”‚  Redis   â”‚
              â”‚ (Primary)â”‚         â”‚ Cluster  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. å¼€å‘è§„èŒƒ

### 7.1 ä»£ç é£æ ¼

- **Python**: Ruff (æ ¼å¼åŒ– + Lint)
- **TypeScript**: ESLint + Prettier
- **æäº¤ä¿¡æ¯**: Conventional Commits

### 7.2 åˆ†æ”¯ç­–ç•¥

```
main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
  â”‚
  â””â”€â–º develop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
        â”‚
        â”œâ”€â–º feature/xxx â”€â”€â–º PR â”€â”€â–º develop
        â”‚
        â””â”€â–º fix/xxx â”€â”€â–º PR â”€â”€â–º develop
```

### 7.3 æµ‹è¯•è¦æ±‚

| ç±»å‹ | è¦†ç›–ç‡è¦æ±‚ | å·¥å…· |
|------|-----------|------|
| å•å…ƒæµ‹è¯• | â‰¥80% | pytest |
| é›†æˆæµ‹è¯• | å…³é”®è·¯å¾„ | pytest + httpx |
| E2E æµ‹è¯• | æ ¸å¿ƒæµç¨‹ | Playwright |

## 8. è¿ç§»è®¡åˆ’

### Phase 1: åŸºç¡€è®¾æ–½ âœ…
- [x] åˆ›å»ºé¡¹ç›®ç»“æ„
- [x] è®¾ç½® FastAPI æ¡†æ¶
- [x] å®šä¹‰æ•°æ®æ¨¡å‹ (SQLAlchemy 2.0)
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬ (Alembic)

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ âœ…
- [x] ç”¨æˆ·è®¤è¯ (JWT + OAuth2)
- [x] gptme é›†æˆ (GptmeEngine)
- [x] èŠå¤© API (SSE æµå¼å“åº”)
- [x] å†å²è®°å½• (å¯¹è¯/æ¶ˆæ¯ CRUD)

### Phase 3: å‰ç«¯ âœ…
- [x] Next.js 15 é¡¹ç›® (App Router)
- [x] æ ¸å¿ƒç»„ä»¶ (ChatArea, Sidebar, DataTable, ChartDisplay)
- [x] API é›†æˆ (Axios + SSE)
- [x] çŠ¶æ€ç®¡ç† (Zustand + TanStack Query)

### Phase 4: å®Œå–„ ğŸ”„
- [x] æ¨¡å‹ç®¡ç† (CRUD + æµ‹è¯•è¿æ¥)
- [x] æ•°æ®åº“è¿æ¥ç®¡ç† (MySQL/PostgreSQL/SQLite)
- [ ] å›½é™…åŒ– (next-intl)
- [x] ä¸»é¢˜åˆ‡æ¢ (7 ä¸ªè‰ºæœ¯ä¸»é¢˜)

### Phase 5: éƒ¨ç½² ğŸ”„
- [x] Docker é…ç½® (docker-compose + Dockerfile)
- [ ] CI/CD (GitHub Actions)
- [x] æ–‡æ¡£å®Œå–„ (API/æ¶æ„æ–‡æ¡£)
- [x] ç¤ºä¾‹æ•°æ®åº“ (demo_db.py)

## 9. å¾…å¼€å‘åŠŸèƒ½

### é«˜ä¼˜å…ˆçº§
- [ ] å›½é™…åŒ– (i18n) - ä¸­è‹±æ–‡åˆ‡æ¢
- [ ] CI/CD æµæ°´çº¿ - è‡ªåŠ¨æµ‹è¯•/éƒ¨ç½²
- [ ] å•å…ƒæµ‹è¯•è¦†ç›– - pytest + vitest

### ä¸­ä¼˜å…ˆçº§
- [ ] æç¤ºè¯æ¨¡æ¿ç®¡ç†
- [ ] æŸ¥è¯¢ç»“æœå¯¼å‡º (CSV/Excel)
- [ ] å¯¹è¯åˆ†äº«åŠŸèƒ½

### ä½ä¼˜å…ˆçº§
- [ ] Mobile App (React Native)
- [ ] CLI Tool
- [ ] Redis ç¼“å­˜é›†æˆ
